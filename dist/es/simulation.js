import { forceSimulation, forceLink, forceCollide, forceCenter } from 'd3';
import Constants from './constants';

var hypotenuse = function hypotenuse(a, b) {
  return Math.sqrt(a * a + b * b);
};

var rectRadius = function rectRadius(_ref) {
  var width = _ref.width,
      height = _ref.height;
  return Math.round(hypotenuse(width, height) / 2);
};

var forcePlayAnimation = function forcePlayAnimation(simulation, animationTicks) {
  var n = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay())) + 100; // - animationTicks;

  for (var i = 0; i < n; ++i) {
    simulation.tick();
  }
};

var createLinks = function createLinks(services) {
  return services.reduce(function (acc, service, index) {
    return service.connections ? acc.concat(service.connections.reduce(function (connections, connection, index) {
      var targetExists = services.filter(function (service) {
        return service.id === connection;
      }).length;
      if (targetExists) {
        connections.push({
          source: service.id,
          target: connection
        });
      }
      return connections;
    }, [])) : acc;
  }, []);
};

var createSimulation = function createSimulation(services, svgSize) {
  var animationTicks = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

  // This is not going to work given that as well as the d3 layout stuff, other things might be at play too
  // We should pass two objects to the components - one for positioning and one for data
  var nodes = services.map(function (service, index) {
    return {
      id: service.id,
      index: index
    };
  });

  var links = createLinks(services);

  var width = svgSize.width,
      height = svgSize.height;


  var nodeRadius = rectRadius(Constants.nodeSizeWithChildren);

  var simulation = forceSimulation(nodes).force('link', forceLink(links).id(function (d) {
    return d.id;
  })).force('collide', forceCollide(nodeRadius)).force('center', forceCenter(width / 2, height / 2));

  forcePlayAnimation(simulation, animationTicks);

  return {
    nodes: nodes,
    links: links,
    simulation: simulation
  };
};

var updateSimulation = function updateSimulation(simulation, services, simNodes, simLinks, svgSize, onTick, onEnd) {
  var nodes = services.map(function (service, index) {
    var simNode = simNodes.reduce(function (acc, n, i) {
      return service.id === n.id ? n : acc;
    }, null);

    return simNode ? {
      id: simNode.id,
      index: index
    } : {
      id: service.id,
      index: index
    };
  });

  var links = createLinks(services);

  var width = svgSize.width,
      height = svgSize.height;


  var nodeRadius = rectRadius(Constants.nodeSizeWithChildren);

  return {
    simulation: forceSimulation(nodes).force('link', forceLink(links).id(function (d) {
      return d.id;
    })).force('collide', forceCollide(nodeRadius)).force('center', forceCenter(width / 2, height / 2)).on('tick', onTick).on('end', onEnd),
    nodes: nodes,
    links: links
  };
};

export { createSimulation, updateSimulation };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaW11bGF0aW9uLmpzIl0sIm5hbWVzIjpbImZvcmNlU2ltdWxhdGlvbiIsImZvcmNlTGluayIsImZvcmNlQ29sbGlkZSIsImZvcmNlQ2VudGVyIiwiQ29uc3RhbnRzIiwiaHlwb3RlbnVzZSIsImEiLCJiIiwiTWF0aCIsInNxcnQiLCJyZWN0UmFkaXVzIiwid2lkdGgiLCJoZWlnaHQiLCJyb3VuZCIsImZvcmNlUGxheUFuaW1hdGlvbiIsInNpbXVsYXRpb24iLCJhbmltYXRpb25UaWNrcyIsIm4iLCJjZWlsIiwibG9nIiwiYWxwaGFNaW4iLCJhbHBoYURlY2F5IiwiaSIsInRpY2siLCJjcmVhdGVMaW5rcyIsInNlcnZpY2VzIiwicmVkdWNlIiwiYWNjIiwic2VydmljZSIsImluZGV4IiwiY29ubmVjdGlvbnMiLCJjb25jYXQiLCJjb25uZWN0aW9uIiwidGFyZ2V0RXhpc3RzIiwiZmlsdGVyIiwiaWQiLCJsZW5ndGgiLCJwdXNoIiwic291cmNlIiwidGFyZ2V0IiwiY3JlYXRlU2ltdWxhdGlvbiIsInN2Z1NpemUiLCJub2RlcyIsIm1hcCIsImxpbmtzIiwibm9kZVJhZGl1cyIsIm5vZGVTaXplV2l0aENoaWxkcmVuIiwiZm9yY2UiLCJkIiwidXBkYXRlU2ltdWxhdGlvbiIsInNpbU5vZGVzIiwic2ltTGlua3MiLCJvblRpY2siLCJvbkVuZCIsInNpbU5vZGUiLCJvbiJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsZUFBVCxFQUEwQkMsU0FBMUIsRUFBcUNDLFlBQXJDLEVBQW1EQyxXQUFuRCxRQUFzRSxJQUF0RTtBQUNBLE9BQU9DLFNBQVAsTUFBc0IsYUFBdEI7O0FBRUEsSUFBTUMsYUFBYSxTQUFiQSxVQUFhLENBQUNDLENBQUQsRUFBSUMsQ0FBSjtBQUFBLFNBQVVDLEtBQUtDLElBQUwsQ0FBVUgsSUFBSUEsQ0FBSixHQUFRQyxJQUFJQSxDQUF0QixDQUFWO0FBQUEsQ0FBbkI7O0FBRUEsSUFBTUcsYUFBYSxTQUFiQSxVQUFhO0FBQUEsTUFBR0MsS0FBSCxRQUFHQSxLQUFIO0FBQUEsTUFBVUMsTUFBVixRQUFVQSxNQUFWO0FBQUEsU0FDakJKLEtBQUtLLEtBQUwsQ0FBV1IsV0FBV00sS0FBWCxFQUFrQkMsTUFBbEIsSUFBNEIsQ0FBdkMsQ0FEaUI7QUFBQSxDQUFuQjs7QUFHQSxJQUFNRSxxQkFBcUIsU0FBckJBLGtCQUFxQixDQUFDQyxVQUFELEVBQWFDLGNBQWIsRUFBZ0M7QUFDekQsTUFBTUMsSUFDSlQsS0FBS1UsSUFBTCxDQUNFVixLQUFLVyxHQUFMLENBQVNKLFdBQVdLLFFBQVgsRUFBVCxJQUFrQ1osS0FBS1csR0FBTCxDQUFTLElBQUlKLFdBQVdNLFVBQVgsRUFBYixDQURwQyxJQUVJLEdBSE4sQ0FEeUQsQ0FJOUM7O0FBRVgsT0FBSyxJQUFJQyxJQUFJLENBQWIsRUFBZ0JBLElBQUlMLENBQXBCLEVBQXVCLEVBQUVLLENBQXpCLEVBQTRCO0FBQzFCUCxlQUFXUSxJQUFYO0FBQ0Q7QUFDRixDQVREOztBQVdBLElBQU1DLGNBQWMsU0FBZEEsV0FBYztBQUFBLFNBQ2xCQyxTQUFTQyxNQUFULENBQ0UsVUFBQ0MsR0FBRCxFQUFNQyxPQUFOLEVBQWVDLEtBQWY7QUFBQSxXQUNFRCxRQUFRRSxXQUFSLEdBQ0lILElBQUlJLE1BQUosQ0FDRUgsUUFBUUUsV0FBUixDQUFvQkosTUFBcEIsQ0FBMkIsVUFBQ0ksV0FBRCxFQUFjRSxVQUFkLEVBQTBCSCxLQUExQixFQUFvQztBQUM3RCxVQUFNSSxlQUFlUixTQUFTUyxNQUFULENBQ25CO0FBQUEsZUFBV04sUUFBUU8sRUFBUixLQUFlSCxVQUExQjtBQUFBLE9BRG1CLEVBRW5CSSxNQUZGO0FBR0EsVUFBSUgsWUFBSixFQUFrQjtBQUNoQkgsb0JBQVlPLElBQVosQ0FBaUI7QUFDZkMsa0JBQVFWLFFBQVFPLEVBREQ7QUFFZkksa0JBQVFQO0FBRk8sU0FBakI7QUFJRDtBQUNELGFBQU9GLFdBQVA7QUFDRCxLQVhELEVBV0csRUFYSCxDQURGLENBREosR0FlSUgsR0FoQk47QUFBQSxHQURGLEVBa0JFLEVBbEJGLENBRGtCO0FBQUEsQ0FBcEI7O0FBc0JBLElBQU1hLG1CQUFtQixTQUFuQkEsZ0JBQW1CLENBQUNmLFFBQUQsRUFBV2dCLE9BQVgsRUFBMkM7QUFBQSxNQUF2QnpCLGNBQXVCLHVFQUFOLENBQU07O0FBQ2xFO0FBQ0E7QUFDQSxNQUFNMEIsUUFBUWpCLFNBQVNrQixHQUFULENBQWEsVUFBQ2YsT0FBRCxFQUFVQyxLQUFWLEVBQW9CO0FBQzdDLFdBQU87QUFDTE0sVUFBSVAsUUFBUU8sRUFEUDtBQUVMTjtBQUZLLEtBQVA7QUFJRCxHQUxhLENBQWQ7O0FBT0EsTUFBTWUsUUFBUXBCLFlBQVlDLFFBQVosQ0FBZDs7QUFWa0UsTUFZMURkLEtBWjBELEdBWXhDOEIsT0Fad0MsQ0FZMUQ5QixLQVowRDtBQUFBLE1BWW5EQyxNQVptRCxHQVl4QzZCLE9BWndDLENBWW5EN0IsTUFabUQ7OztBQWNsRSxNQUFNaUMsYUFBYW5DLFdBQVdOLFVBQVUwQyxvQkFBckIsQ0FBbkI7O0FBRUEsTUFBTS9CLGFBQWFmLGdCQUFnQjBDLEtBQWhCLEVBQ2hCSyxLQURnQixDQUNWLE1BRFUsRUFDRjlDLFVBQVUyQyxLQUFWLEVBQWlCVCxFQUFqQixDQUFvQjtBQUFBLFdBQUthLEVBQUViLEVBQVA7QUFBQSxHQUFwQixDQURFLEVBRWhCWSxLQUZnQixDQUVWLFNBRlUsRUFFQzdDLGFBQWEyQyxVQUFiLENBRkQsRUFHaEJFLEtBSGdCLENBR1YsUUFIVSxFQUdBNUMsWUFBWVEsUUFBUSxDQUFwQixFQUF1QkMsU0FBUyxDQUFoQyxDQUhBLENBQW5COztBQUtBRSxxQkFBbUJDLFVBQW5CLEVBQStCQyxjQUEvQjs7QUFFQSxTQUFPO0FBQ0wwQixnQkFESztBQUVMRSxnQkFGSztBQUdMN0I7QUFISyxHQUFQO0FBS0QsQ0E1QkQ7O0FBOEJBLElBQU1rQyxtQkFBbUIsU0FBbkJBLGdCQUFtQixDQUN2QmxDLFVBRHVCLEVBRXZCVSxRQUZ1QixFQUd2QnlCLFFBSHVCLEVBSXZCQyxRQUp1QixFQUt2QlYsT0FMdUIsRUFNdkJXLE1BTnVCLEVBT3ZCQyxLQVB1QixFQVFwQjtBQUNILE1BQU1YLFFBQVFqQixTQUFTa0IsR0FBVCxDQUFhLFVBQUNmLE9BQUQsRUFBVUMsS0FBVixFQUFvQjtBQUM3QyxRQUFNeUIsVUFBVUosU0FBU3hCLE1BQVQsQ0FBZ0IsVUFBQ0MsR0FBRCxFQUFNVixDQUFOLEVBQVNLLENBQVQsRUFBZTtBQUM3QyxhQUFPTSxRQUFRTyxFQUFSLEtBQWVsQixFQUFFa0IsRUFBakIsR0FBc0JsQixDQUF0QixHQUEwQlUsR0FBakM7QUFDRCxLQUZlLEVBRWIsSUFGYSxDQUFoQjs7QUFJQSxXQUFPMkIsVUFDSDtBQUNFbkIsVUFBSW1CLFFBQVFuQixFQURkO0FBRUVOO0FBRkYsS0FERyxHQUtIO0FBQ0VNLFVBQUlQLFFBQVFPLEVBRGQ7QUFFRU47QUFGRixLQUxKO0FBU0QsR0FkYSxDQUFkOztBQWdCQSxNQUFNZSxRQUFRcEIsWUFBWUMsUUFBWixDQUFkOztBQWpCRyxNQW1CS2QsS0FuQkwsR0FtQnVCOEIsT0FuQnZCLENBbUJLOUIsS0FuQkw7QUFBQSxNQW1CWUMsTUFuQlosR0FtQnVCNkIsT0FuQnZCLENBbUJZN0IsTUFuQlo7OztBQXFCSCxNQUFNaUMsYUFBYW5DLFdBQVdOLFVBQVUwQyxvQkFBckIsQ0FBbkI7O0FBRUEsU0FBTztBQUNML0IsZ0JBQVlmLGdCQUFnQjBDLEtBQWhCLEVBQ1RLLEtBRFMsQ0FDSCxNQURHLEVBQ0s5QyxVQUFVMkMsS0FBVixFQUFpQlQsRUFBakIsQ0FBb0I7QUFBQSxhQUFLYSxFQUFFYixFQUFQO0FBQUEsS0FBcEIsQ0FETCxFQUVUWSxLQUZTLENBRUgsU0FGRyxFQUVRN0MsYUFBYTJDLFVBQWIsQ0FGUixFQUdURSxLQUhTLENBR0gsUUFIRyxFQUdPNUMsWUFBWVEsUUFBUSxDQUFwQixFQUF1QkMsU0FBUyxDQUFoQyxDQUhQLEVBSVQyQyxFQUpTLENBSU4sTUFKTSxFQUlFSCxNQUpGLEVBS1RHLEVBTFMsQ0FLTixLQUxNLEVBS0NGLEtBTEQsQ0FEUDtBQU9MWCxnQkFQSztBQVFMRTtBQVJLLEdBQVA7QUFVRCxDQXpDRDs7QUEyQ0EsU0FBU0osZ0JBQVQsRUFBMkJTLGdCQUEzQiIsImZpbGUiOiJzaW11bGF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9yY2VTaW11bGF0aW9uLCBmb3JjZUxpbmssIGZvcmNlQ29sbGlkZSwgZm9yY2VDZW50ZXIgfSBmcm9tICdkMyc7XG5pbXBvcnQgQ29uc3RhbnRzIGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgaHlwb3RlbnVzZSA9IChhLCBiKSA9PiBNYXRoLnNxcnQoYSAqIGEgKyBiICogYik7XG5cbmNvbnN0IHJlY3RSYWRpdXMgPSAoeyB3aWR0aCwgaGVpZ2h0IH0pID0+XG4gIE1hdGgucm91bmQoaHlwb3RlbnVzZSh3aWR0aCwgaGVpZ2h0KSAvIDIpO1xuXG5jb25zdCBmb3JjZVBsYXlBbmltYXRpb24gPSAoc2ltdWxhdGlvbiwgYW5pbWF0aW9uVGlja3MpID0+IHtcbiAgY29uc3QgbiA9XG4gICAgTWF0aC5jZWlsKFxuICAgICAgTWF0aC5sb2coc2ltdWxhdGlvbi5hbHBoYU1pbigpKSAvIE1hdGgubG9nKDEgLSBzaW11bGF0aW9uLmFscGhhRGVjYXkoKSlcbiAgICApICsgMTAwOyAvLyAtIGFuaW1hdGlvblRpY2tzO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB7XG4gICAgc2ltdWxhdGlvbi50aWNrKCk7XG4gIH1cbn07XG5cbmNvbnN0IGNyZWF0ZUxpbmtzID0gc2VydmljZXMgPT5cbiAgc2VydmljZXMucmVkdWNlKFxuICAgIChhY2MsIHNlcnZpY2UsIGluZGV4KSA9PlxuICAgICAgc2VydmljZS5jb25uZWN0aW9uc1xuICAgICAgICA/IGFjYy5jb25jYXQoXG4gICAgICAgICAgICBzZXJ2aWNlLmNvbm5lY3Rpb25zLnJlZHVjZSgoY29ubmVjdGlvbnMsIGNvbm5lY3Rpb24sIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHRhcmdldEV4aXN0cyA9IHNlcnZpY2VzLmZpbHRlcihcbiAgICAgICAgICAgICAgICBzZXJ2aWNlID0+IHNlcnZpY2UuaWQgPT09IGNvbm5lY3Rpb25cbiAgICAgICAgICAgICAgKS5sZW5ndGg7XG4gICAgICAgICAgICAgIGlmICh0YXJnZXRFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIHNvdXJjZTogc2VydmljZS5pZCxcbiAgICAgICAgICAgICAgICAgIHRhcmdldDogY29ubmVjdGlvblxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9ucztcbiAgICAgICAgICAgIH0sIFtdKVxuICAgICAgICAgIClcbiAgICAgICAgOiBhY2MsXG4gICAgW11cbiAgKTtcblxuY29uc3QgY3JlYXRlU2ltdWxhdGlvbiA9IChzZXJ2aWNlcywgc3ZnU2l6ZSwgYW5pbWF0aW9uVGlja3MgPSAwKSA9PiB7XG4gIC8vIFRoaXMgaXMgbm90IGdvaW5nIHRvIHdvcmsgZ2l2ZW4gdGhhdCBhcyB3ZWxsIGFzIHRoZSBkMyBsYXlvdXQgc3R1ZmYsIG90aGVyIHRoaW5ncyBtaWdodCBiZSBhdCBwbGF5IHRvb1xuICAvLyBXZSBzaG91bGQgcGFzcyB0d28gb2JqZWN0cyB0byB0aGUgY29tcG9uZW50cyAtIG9uZSBmb3IgcG9zaXRpb25pbmcgYW5kIG9uZSBmb3IgZGF0YVxuICBjb25zdCBub2RlcyA9IHNlcnZpY2VzLm1hcCgoc2VydmljZSwgaW5kZXgpID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHNlcnZpY2UuaWQsXG4gICAgICBpbmRleFxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0IGxpbmtzID0gY3JlYXRlTGlua3Moc2VydmljZXMpO1xuXG4gIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gc3ZnU2l6ZTtcblxuICBjb25zdCBub2RlUmFkaXVzID0gcmVjdFJhZGl1cyhDb25zdGFudHMubm9kZVNpemVXaXRoQ2hpbGRyZW4pO1xuXG4gIGNvbnN0IHNpbXVsYXRpb24gPSBmb3JjZVNpbXVsYXRpb24obm9kZXMpXG4gICAgLmZvcmNlKCdsaW5rJywgZm9yY2VMaW5rKGxpbmtzKS5pZChkID0+IGQuaWQpKVxuICAgIC5mb3JjZSgnY29sbGlkZScsIGZvcmNlQ29sbGlkZShub2RlUmFkaXVzKSlcbiAgICAuZm9yY2UoJ2NlbnRlcicsIGZvcmNlQ2VudGVyKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMikpO1xuXG4gIGZvcmNlUGxheUFuaW1hdGlvbihzaW11bGF0aW9uLCBhbmltYXRpb25UaWNrcyk7XG5cbiAgcmV0dXJuIHtcbiAgICBub2RlcyxcbiAgICBsaW5rcyxcbiAgICBzaW11bGF0aW9uXG4gIH07XG59O1xuXG5jb25zdCB1cGRhdGVTaW11bGF0aW9uID0gKFxuICBzaW11bGF0aW9uLFxuICBzZXJ2aWNlcyxcbiAgc2ltTm9kZXMsXG4gIHNpbUxpbmtzLFxuICBzdmdTaXplLFxuICBvblRpY2ssXG4gIG9uRW5kXG4pID0+IHtcbiAgY29uc3Qgbm9kZXMgPSBzZXJ2aWNlcy5tYXAoKHNlcnZpY2UsIGluZGV4KSA9PiB7XG4gICAgY29uc3Qgc2ltTm9kZSA9IHNpbU5vZGVzLnJlZHVjZSgoYWNjLCBuLCBpKSA9PiB7XG4gICAgICByZXR1cm4gc2VydmljZS5pZCA9PT0gbi5pZCA/IG4gOiBhY2M7XG4gICAgfSwgbnVsbCk7XG5cbiAgICByZXR1cm4gc2ltTm9kZVxuICAgICAgPyB7XG4gICAgICAgICAgaWQ6IHNpbU5vZGUuaWQsXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgICAgaWQ6IHNlcnZpY2UuaWQsXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgfTtcbiAgfSk7XG5cbiAgY29uc3QgbGlua3MgPSBjcmVhdGVMaW5rcyhzZXJ2aWNlcyk7XG5cbiAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBzdmdTaXplO1xuXG4gIGNvbnN0IG5vZGVSYWRpdXMgPSByZWN0UmFkaXVzKENvbnN0YW50cy5ub2RlU2l6ZVdpdGhDaGlsZHJlbik7XG5cbiAgcmV0dXJuIHtcbiAgICBzaW11bGF0aW9uOiBmb3JjZVNpbXVsYXRpb24obm9kZXMpXG4gICAgICAuZm9yY2UoJ2xpbmsnLCBmb3JjZUxpbmsobGlua3MpLmlkKGQgPT4gZC5pZCkpXG4gICAgICAuZm9yY2UoJ2NvbGxpZGUnLCBmb3JjZUNvbGxpZGUobm9kZVJhZGl1cykpXG4gICAgICAuZm9yY2UoJ2NlbnRlcicsIGZvcmNlQ2VudGVyKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMikpXG4gICAgICAub24oJ3RpY2snLCBvblRpY2spXG4gICAgICAub24oJ2VuZCcsIG9uRW5kKSxcbiAgICBub2RlcyxcbiAgICBsaW5rc1xuICB9O1xufTtcblxuZXhwb3J0IHsgY3JlYXRlU2ltdWxhdGlvbiwgdXBkYXRlU2ltdWxhdGlvbiB9O1xuIl19