'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateSimulation = exports.createSimulation = undefined;

var _d = require('d3');

var _constants = require('./constants');

var _constants2 = _interopRequireDefault(_constants);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const hypotenuse = (a, b) => Math.sqrt(a * a + b * b);

const rectRadius = ({ width, height }) => Math.round(hypotenuse(width, height) / 2);

const forcePlayAnimation = (simulation, animationTicks) => {
  const n = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay())) + 100; // - animationTicks;

  for (let i = 0; i < n; ++i) {
    simulation.tick();
  }
};

const createLinks = services => services.reduce((acc, service, index) => service.connections ? acc.concat(service.connections.reduce((connections, connection, index) => {
  const targetExists = services.filter(service => service.id === connection).length;
  if (targetExists) {
    connections.push({
      source: service.id,
      target: connection
    });
  }
  return connections;
}, [])) : acc, []);

const createSimulation = (services, svgSize, animationTicks = 0) => {
  // This is not going to work given that as well as the d3 layout stuff, other things might be at play too
  // We should pass two objects to the components - one for positioning and one for data
  const nodes = services.map((service, index) => {
    return {
      id: service.id,
      index
    };
  });

  const links = createLinks(services);

  const { width, height } = svgSize;

  const nodeRadius = rectRadius(_constants2.default.nodeSizeWithChildren);

  const simulation = (0, _d.forceSimulation)(nodes).force('link', (0, _d.forceLink)(links).id(d => d.id)).force('collide', (0, _d.forceCollide)(nodeRadius)).force('center', (0, _d.forceCenter)(width / 2, height / 2));

  forcePlayAnimation(simulation, animationTicks);

  return {
    nodes,
    links,
    simulation
  };
};

const updateSimulation = (simulation, services, simNodes, simLinks, svgSize, onTick, onEnd) => {
  const nodes = services.map((service, index) => {
    const simNode = simNodes.reduce((acc, n, i) => {
      return service.id === n.id ? n : acc;
    }, null);

    return simNode ? {
      id: simNode.id,
      index
    } : {
      id: service.id,
      index
    };
  });

  const links = createLinks(services);

  const { width, height } = svgSize;

  const nodeRadius = rectRadius(_constants2.default.nodeSizeWithChildren);

  return {
    simulation: (0, _d.forceSimulation)(nodes).force('link', (0, _d.forceLink)(links).id(d => d.id)).force('collide', (0, _d.forceCollide)(nodeRadius)).force('center', (0, _d.forceCenter)(width / 2, height / 2)).on('tick', onTick).on('end', onEnd),
    nodes,
    links
  };
};

exports.createSimulation = createSimulation;
exports.updateSimulation = updateSimulation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaW11bGF0aW9uLmpzIl0sIm5hbWVzIjpbImh5cG90ZW51c2UiLCJhIiwiYiIsIk1hdGgiLCJzcXJ0IiwicmVjdFJhZGl1cyIsIndpZHRoIiwiaGVpZ2h0Iiwicm91bmQiLCJmb3JjZVBsYXlBbmltYXRpb24iLCJzaW11bGF0aW9uIiwiYW5pbWF0aW9uVGlja3MiLCJuIiwiY2VpbCIsImxvZyIsImFscGhhTWluIiwiYWxwaGFEZWNheSIsImkiLCJ0aWNrIiwiY3JlYXRlTGlua3MiLCJzZXJ2aWNlcyIsInJlZHVjZSIsImFjYyIsInNlcnZpY2UiLCJpbmRleCIsImNvbm5lY3Rpb25zIiwiY29uY2F0IiwiY29ubmVjdGlvbiIsInRhcmdldEV4aXN0cyIsImZpbHRlciIsImlkIiwibGVuZ3RoIiwicHVzaCIsInNvdXJjZSIsInRhcmdldCIsImNyZWF0ZVNpbXVsYXRpb24iLCJzdmdTaXplIiwibm9kZXMiLCJtYXAiLCJsaW5rcyIsIm5vZGVSYWRpdXMiLCJub2RlU2l6ZVdpdGhDaGlsZHJlbiIsImZvcmNlIiwiZCIsInVwZGF0ZVNpbXVsYXRpb24iLCJzaW1Ob2RlcyIsInNpbUxpbmtzIiwib25UaWNrIiwib25FbmQiLCJzaW1Ob2RlIiwib24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsYUFBYSxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUMsS0FBS0MsSUFBTCxDQUFVSCxJQUFJQSxDQUFKLEdBQVFDLElBQUlBLENBQXRCLENBQTdCOztBQUVBLE1BQU1HLGFBQWEsQ0FBQyxFQUFFQyxLQUFGLEVBQVNDLE1BQVQsRUFBRCxLQUNqQkosS0FBS0ssS0FBTCxDQUFXUixXQUFXTSxLQUFYLEVBQWtCQyxNQUFsQixJQUE0QixDQUF2QyxDQURGOztBQUdBLE1BQU1FLHFCQUFxQixDQUFDQyxVQUFELEVBQWFDLGNBQWIsS0FBZ0M7QUFDekQsUUFBTUMsSUFDSlQsS0FBS1UsSUFBTCxDQUNFVixLQUFLVyxH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QUFZQyxRQUFaLENBQWQ7O0FBRUEsUUFBTSxFQUFFZCxLQUFGLEVBQVNDLE1BQVQsS0FBb0I2QixPQUExQjs7QUFFQSxRQUFNSSxhQUFhbkMsV0FBVyxvQkFBVW9DLG9CQUFyQixDQUFuQjs7QUFFQSxTQUFPO0FBQ0wvQixnQkFBWSx3QkFBZ0IyQixLQUFoQixFQUNUSyxLQURTLENBQ0gsTUFERyxFQUNLLGtCQUFVSCxLQUFWLEVBQWlCVCxFQUFqQixDQUFvQmEsS0FBS0EsRUFBRWIsRUFBM0IsQ0FETCxFQUVUWSxLQUZTLENBRUgsU0FGRyxFQUVRLHFCQUFhRixVQUFiLENBRlIsRUFHVEUsS0FIUyxDQUdILFFBSEcsRUFHTyxvQkFBWXBDLFFBQVEsQ0FBcEIsRUFBdUJDLFNBQVMsQ0FBaEMsQ0FIUCxFQUlUMkMsRUFKUyxDQUlOLE1BSk0sRUFJRUgsTUFKRixFQUtURyxFQUxTLENBS04sS0FMTSxFQUtDRixLQUxELENBRFA7QUFPTFgsU0FQSztBQVFMRTtBQVJLLEdBQVA7QUFVRCxDQXpDRDs7UUEyQ1NKLGdCLEdBQUFBLGdCO1FBQWtCUyxnQixHQUFBQSxnQiIsImZpbGUiOiJzaW11bGF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9yY2VTaW11bGF0aW9uLCBmb3JjZUxpbmssIGZvcmNlQ29sbGlkZSwgZm9yY2VDZW50ZXIgfSBmcm9tICdkMyc7XG5pbXBvcnQgQ29uc3RhbnRzIGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgaHlwb3RlbnVzZSA9IChhLCBiKSA9PiBNYXRoLnNxcnQoYSAqIGEgKyBiICogYik7XG5cbmNvbnN0IHJlY3RSYWRpdXMgPSAoeyB3aWR0aCwgaGVpZ2h0IH0pID0+XG4gIE1hdGgucm91bmQoaHlwb3RlbnVzZSh3aWR0aCwgaGVpZ2h0KSAvIDIpO1xuXG5jb25zdCBmb3JjZVBsYXlBbmltYXRpb24gPSAoc2ltdWxhdGlvbiwgYW5pbWF0aW9uVGlja3MpID0+IHtcbiAgY29uc3QgbiA9XG4gICAgTWF0aC5jZWlsKFxuICAgICAgTWF0aC5sb2coc2ltdWxhdGlvbi5hbHBoYU1pbigpKSAvIE1hdGgubG9nKDEgLSBzaW11bGF0aW9uLmFscGhhRGVjYXkoKSlcbiAgICApICsgMTAwOyAvLyAtIGFuaW1hdGlvblRpY2tzO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB7XG4gICAgc2ltdWxhdGlvbi50aWNrKCk7XG4gIH1cbn07XG5cbmNvbnN0IGNyZWF0ZUxpbmtzID0gc2VydmljZXMgPT5cbiAgc2VydmljZXMucmVkdWNlKFxuICAgIChhY2MsIHNlcnZpY2UsIGluZGV4KSA9PlxuICAgICAgc2VydmljZS5jb25uZWN0aW9uc1xuICAgICAgICA/IGFjYy5jb25jYXQoXG4gICAgICAgICAgICBzZXJ2aWNlLmNvbm5lY3Rpb25zLnJlZHVjZSgoY29ubmVjdGlvbnMsIGNvbm5lY3Rpb24sIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHRhcmdldEV4aXN0cyA9IHNlcnZpY2VzLmZpbHRlcihcbiAgICAgICAgICAgICAgICBzZXJ2aWNlID0+IHNlcnZpY2UuaWQgPT09IGNvbm5lY3Rpb25cbiAgICAgICAgICAgICAgKS5sZW5ndGg7XG4gICAgICAgICAgICAgIGlmICh0YXJnZXRFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIHNvdXJjZTogc2VydmljZS5pZCxcbiAgICAgICAgICAgICAgICAgIHRhcmdldDogY29ubmVjdGlvblxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9ucztcbiAgICAgICAgICAgIH0sIFtdKVxuICAgICAgICAgIClcbiAgICAgICAgOiBhY2MsXG4gICAgW11cbiAgKTtcblxuY29uc3QgY3JlYXRlU2ltdWxhdGlvbiA9IChzZXJ2aWNlcywgc3ZnU2l6ZSwgYW5pbWF0aW9uVGlja3MgPSAwKSA9PiB7XG4gIC8vIFRoaXMgaXMgbm90IGdvaW5nIHRvIHdvcmsgZ2l2ZW4gdGhhdCBhcyB3ZWxsIGFzIHRoZSBkMyBsYXlvdXQgc3R1ZmYsIG90aGVyIHRoaW5ncyBtaWdodCBiZSBhdCBwbGF5IHRvb1xuICAvLyBXZSBzaG91bGQgcGFzcyB0d28gb2JqZWN0cyB0byB0aGUgY29tcG9uZW50cyAtIG9uZSBmb3IgcG9zaXRpb25pbmcgYW5kIG9uZSBmb3IgZGF0YVxuICBjb25zdCBub2RlcyA9IHNlcnZpY2VzLm1hcCgoc2VydmljZSwgaW5kZXgpID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHNlcnZpY2UuaWQsXG4gICAgICBpbmRleFxuICAgIH07XG4gIH0pO1xuXG4gIGNvbnN0IGxpbmtzID0gY3JlYXRlTGlua3Moc2VydmljZXMpO1xuXG4gIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gc3ZnU2l6ZTtcblxuICBjb25zdCBub2RlUmFkaXVzID0gcmVjdFJhZGl1cyhDb25zdGFudHMubm9kZVNpemVXaXRoQ2hpbGRyZW4pO1xuXG4gIGNvbnN0IHNpbXVsYXRpb24gPSBmb3JjZVNpbXVsYXRpb24obm9kZXMpXG4gICAgLmZvcmNlKCdsaW5rJywgZm9yY2VMaW5rKGxpbmtzKS5pZChkID0+IGQuaWQpKVxuICAgIC5mb3JjZSgnY29sbGlkZScsIGZvcmNlQ29sbGlkZShub2RlUmFkaXVzKSlcbiAgICAuZm9yY2UoJ2NlbnRlcicsIGZvcmNlQ2VudGVyKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMikpO1xuXG4gIGZvcmNlUGxheUFuaW1hdGlvbihzaW11bGF0aW9uLCBhbmltYXRpb25UaWNrcyk7XG5cbiAgcmV0dXJuIHtcbiAgICBub2RlcyxcbiAgICBsaW5rcyxcbiAgICBzaW11bGF0aW9uXG4gIH07XG59O1xuXG5jb25zdCB1cGRhdGVTaW11bGF0aW9uID0gKFxuICBzaW11bGF0aW9uLFxuICBzZXJ2aWNlcyxcbiAgc2ltTm9kZXMsXG4gIHNpbUxpbmtzLFxuICBzdmdTaXplLFxuICBvblRpY2ssXG4gIG9uRW5kXG4pID0+IHtcbiAgY29uc3Qgbm9kZXMgPSBzZXJ2aWNlcy5tYXAoKHNlcnZpY2UsIGluZGV4KSA9PiB7XG4gICAgY29uc3Qgc2ltTm9kZSA9IHNpbU5vZGVzLnJlZHVjZSgoYWNjLCBuLCBpKSA9PiB7XG4gICAgICByZXR1cm4gc2VydmljZS5pZCA9PT0gbi5pZCA/IG4gOiBhY2M7XG4gICAgfSwgbnVsbCk7XG5cbiAgICByZXR1cm4gc2ltTm9kZVxuICAgICAgPyB7XG4gICAgICAgICAgaWQ6IHNpbU5vZGUuaWQsXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgICAgaWQ6IHNlcnZpY2UuaWQsXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgfTtcbiAgfSk7XG5cbiAgY29uc3QgbGlua3MgPSBjcmVhdGVMaW5rcyhzZXJ2aWNlcyk7XG5cbiAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBzdmdTaXplO1xuXG4gIGNvbnN0IG5vZGVSYWRpdXMgPSByZWN0UmFkaXVzKENvbnN0YW50cy5ub2RlU2l6ZVdpdGhDaGlsZHJlbik7XG5cbiAgcmV0dXJuIHtcbiAgICBzaW11bGF0aW9uOiBmb3JjZVNpbXVsYXRpb24obm9kZXMpXG4gICAgICAuZm9yY2UoJ2xpbmsnLCBmb3JjZUxpbmsobGlua3MpLmlkKGQgPT4gZC5pZCkpXG4gICAgICAuZm9yY2UoJ2NvbGxpZGUnLCBmb3JjZUNvbGxpZGUobm9kZVJhZGl1cykpXG4gICAgICAuZm9yY2UoJ2NlbnRlcicsIGZvcmNlQ2VudGVyKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMikpXG4gICAgICAub24oJ3RpY2snLCBvblRpY2spXG4gICAgICAub24oJ2VuZCcsIG9uRW5kKSxcbiAgICBub2RlcyxcbiAgICBsaW5rc1xuICB9O1xufTtcblxuZXhwb3J0IHsgY3JlYXRlU2ltdWxhdGlvbiwgdXBkYXRlU2ltdWxhdGlvbiB9O1xuIl19